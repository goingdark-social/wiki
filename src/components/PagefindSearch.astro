---
// Pagefind Search Component - Static Site Search
---

<div id="pagefind-search" class="mb-6">
  <div id="search-input-container" class="relative">
    <div class="search-icon-container">
      <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <input
      id="pagefind-search-input"
      type="search"
      placeholder="Search documentation..."
      class="pagefind-input"
    />
  </div>
  <div id="pagefind-results" class="search-results"></div>
</div>

<script is:inline>
  // Load Pagefind at runtime (not build time)
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('pagefind-search-input');
    const resultsContainer = document.getElementById('pagefind-results');

    if (!searchInput || !resultsContainer) return;

    let pagefind = null;
    let debounceTimer;

    // Load Pagefind dynamically at runtime
    const loadPagefind = async () => {
      try {
        const module = await import('/pagefind/pagefind.js');
        await module.init();
        return module;
      } catch (error) {
        console.warn('Pagefind not available:', error);
        return null;
      }
    };

    searchInput.addEventListener('input', async (e) => {
      const query = e.target.value;

      clearTimeout(debounceTimer);

      if (!query || query.length < 2) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
        return;
      }

      debounceTimer = setTimeout(async () => {
        // Load Pagefind on first search
        if (!pagefind) {
          pagefind = await loadPagefind();
          if (!pagefind) {
            resultsContainer.innerHTML = '<p class="search-no-results">Search index not available. Run build first.</p>';
            resultsContainer.classList.remove('hidden');
            return;
          }
        }

        const search = await pagefind.search(query);

        if (search.results.length === 0) {
          resultsContainer.innerHTML = '<p class="search-no-results">No results found</p>';
          resultsContainer.classList.remove('hidden');
          return;
        }

        // Render results
        const resultsHTML = await Promise.all(
          search.results.slice(0, 5).map(async (result) => {
            const data = await result.data();
            return `
              <a
                href="${data.url}"
                class="search-result-item"
              >
                <div class="search-result-title">${data.meta.title || 'Untitled'}</div>
                <div class="search-result-excerpt">${data.excerpt || ''}</div>
              </a>
            `;
          })
        );

        resultsContainer.innerHTML = resultsHTML.join('');
        resultsContainer.classList.remove('hidden');
      }, 300);
    });

    // Close results when clicking outside
    document.addEventListener('click', (e) => {
      if (!document.getElementById('pagefind-search')?.contains(e.target)) {
        resultsContainer.classList.add('hidden');
      }
    });

    // Handle escape key
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        resultsContainer.classList.add('hidden');
        searchInput.blur();
      }
    });
  });
</script>
